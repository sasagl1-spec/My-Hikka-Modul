# -*- coding: utf-8 -*-
# –ú–æ–¥—É–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram —á–∞—Ç—ã
# –û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–´–ô –ü–†–ò–ú–ï–† - —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ

from .. import loader, utils
import asyncio
import random
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

@loader.tds
class AutoPosterModule(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç—ã"""
    
    strings = {
        "name": "AutoPoster",
        "active": "‚úÖ –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω",
        "inactive": "‚èπÔ∏è –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω",
        "starting": "üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞...",
        "error": "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ"
    }

    def __init__(self):
        self.is_running = False
        self.task = None
        self.message_count = 0
        
        # –¶–µ–ª–µ–≤—ã–µ —á–∞—Ç—ã
        self.target_chats = [
            "https://t.me/piteraq",
            "https://t.me/vpiskavipspb",
            "https://t.me/VpISkA991", 
            "https://t.me/sextimeeeeeee",
            "https://t.me/vpiski_ekat",
            "https://t.me/tusovkimscspb",
            "https://t.me/vpiski_spb_piter_znakomstva",
            "https://t.me/vpiskimsksspb",
            "https://t.me/chat_berdjansk",
            "https://t.me/chatikiip",
            "https://t.me/vpisk_moskova",
            "https://t.me/moskva_vpiskip",
            "https://t.me/Moskvavispka",
            "https://t.me/vpiska_chelyaba001",
            "https://t.me/vpiskaa_spb",
            "https://t.me/vpiska_beseda"
        ]
        
        # –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        self.message_text = "–≠—Å–∫–æ—Ä—Ç —É—Å–ª—É–≥–∏ —É –º–µ–Ω—è –≤ –ø—Ä–æ—Ñ–∏–ª–µü§§ \n–î–µ–≤—É—à–∫–∏ –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Åüíå"

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("–ú–æ–¥—É–ª—å AutoPoster –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    async def ap_startcmd(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥: .ap_start"""
        if self.is_running:
            await utils.answer(message, "‚ö†Ô∏è –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
            return
            
        self.is_running = True
        await utils.answer(message, self.strings["starting"])
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
        self.task = asyncio.create_task(self.posting_loop())
        await utils.answer(message, self.strings["active"])
        
        logger.info(f"–ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω –≤ {datetime.now()}")

    async def ap_stopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥: .ap_stop"""
        if not self.is_running:
            await utils.answer(message, "‚ÑπÔ∏è –ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –Ω–µ –∑–∞–ø—É—â–µ–Ω")
            return
            
        self.is_running = False
        if self.task:
            self.task.cancel()
            try:
                await self.task
            except asyncio.CancelledError:
                pass
                
        await utils.answer(message, self.strings["inactive"])
        logger.info(f"–ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ {datetime.now()}")

    async def ap_statscmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: .ap_stats"""
        stats = f"""
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥–∞:

‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {self.message_count}
‚Ä¢ –¶–µ–ª–µ–≤—ã—Ö —á–∞—Ç–æ–≤: {len(self.target_chats)}
‚Ä¢ –°—Ç–∞—Ç—É—Å: {'üü¢ –ê–∫—Ç–∏–≤–µ–Ω' if self.is_running else 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {datetime.now().strftime('%H:%M:%S')}
        """
        await utils.answer(message, stats)

    async def ap_testcmd(self, message):
        """–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ 1 —á–∞—Ç: .ap_test"""
        try:
            if not self.target_chats:
                await utils.answer(message, "‚ùå –ù–µ—Ç —Ü–µ–ª–µ–≤—ã—Ö —á–∞—Ç–æ–≤")
                return
                
            test_chat = random.choice(self.target_chats)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            await self.client.send_message(test_chat, self.message_text)
            self.message_count += 1
            
            await utils.answer(message, f"‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤:\n{test_chat}")
            logger.info(f"–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ {test_chat}")
            
        except Exception as e:
            await utils.answer(message, f"{self.strings['error']}: {str(e)}")
            logger.error(f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

    async def ap_listcmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤: .ap_list"""
        if not self.target_chats:
            await utils.answer(message, "üì≠ –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –ø—É—Å—Ç")
            return
            
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 —á–∞—Ç–æ–≤
        chat_list = "\n".join([f"{i+1}. {chat}" for i, chat in enumerate(self.target_chats[:10])])
        
        if len(self.target_chats) > 10:
            chat_list += f"\n... –∏ –µ—â–µ {len(self.target_chats) - 10} —á–∞—Ç–æ–≤"
            
        await utils.answer(message, f"üìã –°–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–≤—ã—Ö —á–∞—Ç–æ–≤:\n{chat_list}")

    async def posting_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        while self.is_running:
            try:
                # –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 5-7 –º–∏–Ω—É—Ç (300-420 —Å–µ–∫—É–Ω–¥)
                delay = random.randint(300, 420)
                logger.info(f"–û–∂–∏–¥–∞–Ω–∏–µ {delay} —Å–µ–∫—É–Ω–¥")
                
                await asyncio.sleep(delay)
                
                if not self.is_running:
                    break
                    
                # –í—ã–±–∏—Ä–∞–µ–º 3 —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∞—Ç–∞
                if len(self.target_chats) >= 3:
                    selected_chats = random.sample(self.target_chats, 3)
                else:
                    selected_chats = self.target_chats
                    
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã
                for chat in selected_chats:
                    try:
                        await self.client.send_message(chat, self.message_text)
                        self.message_count += 1
                        logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {chat}")
                        
                        # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
                        await asyncio.sleep(random.uniform(1.0, 3.0))
                        
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ {chat}: {e}")
                        continue
                        
                logger.info(f"–¶–∏–∫–ª –∑–∞–≤–µ—Ä—à–µ–Ω. –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–æ–∫: {self.message_count}")
                
            except asyncio.CancelledError:
                logger.info("–¶–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–µ—Ä–≤–∞–Ω")
                break
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}")
                await asyncio.sleep(60)  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–µ

    async def ap_helpcmd(self, message):
        """–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º: .ap_help"""
        help_text = """
ü§ñ –ú–û–î–£–õ–¨ –ê–í–¢–û–ü–û–°–¢–ò–ù–ì–ê

–ö–æ–º–∞–Ω–¥—ã:
‚Ä¢ .ap_start - –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥
‚Ä¢ .ap_stop - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥
‚Ä¢ .ap_stats - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
‚Ä¢ .ap_test - —Ç–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ 1 —á–∞—Ç
‚Ä¢ .ap_list - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
‚Ä¢ .ap_help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

–ù–∞—Å—Ç—Ä–æ–π–∫–∏:
‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª: 5-7 –º–∏–Ω—É—Ç (—Å–ª—É—á–∞–π–Ω—ã–π)
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Ç–æ–≤ –∑–∞ —Ü–∏–∫–ª: 3
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–µ: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ

‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö
        """
        await utils.answer(message, help_text)

    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è"""
        self.is_running = False
        if self.task:
            self.task.cancel()
        logger.info("–ú–æ–¥—É–ª—å AutoPoster –≤—ã–≥—Ä—É–∂–µ–Ω")
