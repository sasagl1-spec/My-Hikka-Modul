# meta developer: @your_username
# meta pic: https://img.icons8.com/color/48/000000/advertisement.png
# meta license: MIT

import asyncio
import time
from datetime import datetime
from telethon.tl.types import Message

from .. import loader, utils

@loader.tds
class TonTakeAdvertiserMod(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–∫–ª–∞–º—ã –≤ TonTakeGarant –∫–∞–∂–¥—ã–µ 47 —Å–æ–æ–±—â–µ–Ω–∏–π"""
    
    strings = {
        "name": "TonTakeAdvertiser",
        "on": "‚úÖ <b>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ</b>",
        "off": "‚ùå <b>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</b>",
        "stats": (
            "üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ TonTakeAdvertiser:</b>\n"
            "–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–æ–∫: {}\n"
            "–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Ç–ø—Ä–∞–≤–∫–∞: {}\n"
            "–û—Ç—Å—á–∏—Ç–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {}/47\n"
            "–°—Ç–∞—Ç—É—Å: {}"
        ),
        "ad_sent": "‚úÖ <b>–†–µ–∫–ª–∞–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ TonTakeGarant</b>",
        "counter_reset": "üîÑ <b>–°—á—ë—Ç—á–∏–∫ —Å–±—Ä–æ—à–µ–Ω –Ω–∞ 0</b>"
    }

    def __init__(self):
        self.config = loader.ModuleConfig(
            loader.ConfigValue(
                "target_channel",
                "https://t.me/TonTakeGarant",
                "–ö–∞–Ω–∞–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∫–ª–∞–º—ã",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "trigger_count",
                47,
                "–°–æ–æ–±—â–µ–Ω–∏–π –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–µ–∫–ª–∞–º—ã",
                validator=loader.validators.Integer(minimum=1, maximum=1000)
            ),
            loader.ConfigValue(
                "ad_text",
                """üéØ –ù–ê–ö–†–£–¢–ö–ê –î–õ–Ø –í–°–ï–• –ü–õ–ê–¢–§–û–†–ú:
‚Äî Telegram, TikTok, –í–ö–æ–Ω—Ç–∞–∫—Ç–µ, Facebook, Instagram
–£—Å–ª—É–≥–∏: –ø—Ä–æ—Å–º–æ—Ç—Ä—ã, —Ä–µ–∞–∫—Ü–∏–∏, –ø–æ–¥–ø–∏—Å—á–∏–∫–∏, —Ä–µ–ø–æ—Å—Ç—ã, —Ä–µ—Ñ–µ—Ä–∞–ª—ã.

üá∫üá∏ –ü–†–û–î–ê–ú –ê–ö–ö–ê–£–ù–¢–´ –°–®–ê (—Å—Ç–∞—Ä—ã–µ):
‚Ä¢ 2015 ‚Äî 950‚ÇΩ
‚Ä¢ 2016 ‚Äî 750‚ÇΩ
‚Ä¢ 2017 ‚Äî 520‚ÇΩ
‚Ä¢ 2018 ‚Äî 450‚ÇΩ

üíµ –û–ø–ª–∞—Ç—É –ø—Ä–∏–Ω–∏–º–∞—é –≤ ‚ÇΩ/–ö—Ä–∏–ø—Ç–µ/$""",
                "–¢–µ–∫—Å—Ç —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è",
                validator=loader.validators.String()
            )
        )
        
        self.message_count = 0
        self.total_sent = 0
        self.last_sent = "–ù–∏–∫–æ–≥–¥–∞"
        self.running = True

    async def client_ready(self, client, db):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞"""
        self.client = client
        self.db = db
        self._me = await client.get_me()

    async def watcher(self, message: Message):
        """–°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ü–µ–ª–µ–≤–æ–º –∫–∞–Ω–∞–ª–µ"""
        if not self.running:
            return
            
        try:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
            chat = await message.get_chat()
            if not chat:
                return
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –Ω—É–∂–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
            chat_link = f"https://t.me/{chat.username}" if chat.username else f"https://t.me/c/{chat.id}"
            target_link = self.config["target_channel"].replace("@", "https://t.me/")
            
            if chat_link == target_link or f"@{chat.username}" == self.config["target_channel"]:
                self.message_count += 1
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞
                if self.message_count >= self.config["trigger_count"]:
                    await self.send_advertisement()
                    self.message_count = 0
                    
        except Exception as e:
            print(f"[TonTakeAdvertiser] –û—à–∏–±–∫–∞: {e}")

    async def send_advertisement(self):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            await self.client.send_message(
                self.config["target_channel"],
                self.config["ad_text"]
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            self.total_sent += 1
            self.last_sent = datetime.now().strftime("%H:%M:%S")
            
            print(f"[TonTakeAdvertiser] –†–µ–∫–ª–∞–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –í—Å–µ–≥–æ: {self.total_sent}")
            
        except Exception as e:
            print(f"[TonTakeAdvertiser] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

    @loader.command()
    async def ttonstart(self, message):
        """–í–∫–ª—é—á–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫—É —Ä–µ–∫–ª–∞–º—ã"""
        self.running = True
        await utils.answer(message, self.strings("on"))

    @loader.command()
    async def ttonstop(self, message):
        """–í—ã–∫–ª—é—á–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ"""
        self.running = False
        await utils.answer(message, self.strings("off"))

    @loader.command()
    async def ttonstats(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –º–æ–¥—É–ª—è"""
        status = "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω" if self.running else "‚ùå –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
        stats_text = self.strings("stats").format(
            self.total_sent,
            self.last_sent,
            self.message_count,
            status
        )
        
        await utils.answer(message, stats_text)

    @loader.command()
    async def ttonreset(self, message):
        """–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        self.message_count = 0
        await utils.answer(message, self.strings("counter_reset"))

    @loader.command()
    async def ttonsend(self, message):
        """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–ª–∞–º—É —Å–µ–π—á–∞—Å"""
        await self.send_advertisement()
        await utils.answer(message, self.strings("ad_sent"))

    @loader.command()
    async def ttonconfig(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"""
        config_text = (
            f"‚öôÔ∏è <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ TonTakeAdvertiser:</b>\n"
            f"‚Ä¢ –ö–∞–Ω–∞–ª: {self.config['target_channel']}\n"
            f"‚Ä¢ –¢—Ä–∏–≥–≥–µ—Ä: –∫–∞–∂–¥—ã–µ {self.config['trigger_count']} —Å–æ–æ–±—â–µ–Ω–∏–π\n"
            f"‚Ä¢ –°—Ç–∞—Ç—É—Å: {'–í–∫–ª—é—á–µ–Ω–æ' if self.running else '–í—ã–∫–ª—é—á–µ–Ω–æ'}\n\n"
            f"<code>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .cfg TonTakeAdvertiser –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫</code>"
        )
        await utils.answer(message, config_text)

    @loader.command()
    async def ttonhelp(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"""
        help_text = (
            "üìñ <b>–ö–æ–º–∞–Ω–¥—ã TonTakeAdvertiser:</b>\n"
            "<code>.ttonstart</code> - –í–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å\n"
            "<code>.ttonstop</code> - –í—ã–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å\n"
            "<code>.ttonstats</code> - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
            "<code>.ttonreset</code> - –°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫\n"
            "<code>.ttonsend</code> - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å\n"
            "<code>.ttonconfig</code> - –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n"
            "<code>.ttonhelp</code> - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
        )
        await utils.answer(message, help_text)
