# meta developer: @kiminaiq
# meta pic: https://img.icons8.com/color/48/000000/wallet--v1.png
# meta description: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è @wallet —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
# scope: hikka_only
# scope: hikka_min 1.6.0

import asyncio
import time
import re
from datetime import datetime, timedelta
from telethon.tl.types import KeyboardButtonRow, KeyboardButtonCallback
from .. import loader, utils
import logging

logger = logging.getLogger(__name__)

@loader.tds
class WalletButtonAutomation(loader.Module):
    """–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è @wallet —á–µ—Ä–µ–∑ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫"""
    
    strings = {
        "name": "WalletButtonBot",
        "started": "‚úÖ <b>–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!</b>\nüîò –ú–µ—Ç–æ–¥: –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫\nüì¢ –ö–∞–Ω–∞–ª: @priceDollarTon\n‚è± –¶–∏–∫–ª: 3 –º–∏–Ω",
        "stopped": "‚èπÔ∏è <b>–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</b>",
        "already_running": "‚ö†Ô∏è <b>–£–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç</b>",
        "not_running": "üì≠ <b>–ù–µ –∑–∞–ø—É—â–µ–Ω</b>",
        "test_sent": "üì§ <b>–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</b>",
        "status": "üîÑ <b>–°—Ç–∞—Ç—É—Å:</b> {}\n‚è∞ <b>–ü–æ—Å–ª–µ–¥–Ω–µ–µ:</b> {}\nüíé <b>–¶–µ–Ω–∞ TON:</b> {}‚ÇΩ",
        "error": "‚ùå <b>–û—à–∏–±–∫–∞:</b> {}",
        "finding_button": "üîç –ò—â—É –∫–Ω–æ–ø–∫—É '–ö–æ—à–µ–ª—ë–∫'...",
        "button_found": "‚úÖ –ö–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞",
        "button_not_found": "‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
        "clicking_button": "üñ±Ô∏è –ù–∞–∂–∏–º–∞—é –∫–Ω–æ–ø–∫—É...",
        "waiting_data": "‚è≥ –ñ–¥—É –¥–∞–Ω–Ω—ã–µ...",
        "no_price_data": "‚ö†Ô∏è –¶–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –æ—Ç–≤–µ—Ç–µ",
        "parsed_success": "‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã"
    }
    
    def __init__(self):
        self.task = None
        self.is_running = False
        self.last_update = None
        self.last_ton_price = None
        self.wallet_bot = "@wallet"
        self.target_channel = "@priceDollarTon"
        self.button_found = False
        
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("WalletButtonBot –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    @loader.command(
        ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ —Å –∫–Ω–æ–ø–æ—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º",
        en_doc="Start bot with button control"
    )
    async def startbuttonbot(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"""
        if self.is_running:
            await utils.answer(message, self.strings("already_running"))
            return
        
        self.is_running = True
        self.task = asyncio.create_task(self._button_automation_loop())
        
        await utils.answer(message, self.strings("started"))
        logger.info("–ë–æ—Ç —Å –∫–Ω–æ–ø–æ—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–ø—É—â–µ–Ω")
    
    @loader.command(
        ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞",
        en_doc="Stop bot"
    )
    async def stopbuttonbot(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞"""
        if not self.is_running:
            await utils.answer(message, self.strings("not_running"))
            return
        
        self.is_running = False
        if self.task:
            self.task.cancel()
            self.task = None
        
        await utils.answer(message, self.strings("stopped"))
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    @loader.command(
        ru_doc="–ù–∞–π—Ç–∏ –∏ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É '–ö–æ—à–µ–ª—ë–∫'",
        en_doc="Find and click '–ö–æ—à–µ–ª—ë–∫' button"
    )
    async def findwalletbutton(self, message):
        """–ù–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É –∫–æ—à–µ–ª—å–∫–∞"""
        await utils.answer(message, self.strings("finding_button"))
        
        try:
            success = await self._find_and_click_wallet_button()
            
            if success:
                await utils.answer(message, self.strings("button_found"))
                
                # –ñ–¥–µ–º –¥–∞–Ω–Ω—ã–µ
                await asyncio.sleep(2)
                
                # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É
                price = await self._extract_price_from_messages()
                if price:
                    await utils.answer(message, f"‚úÖ –¶–µ–Ω–∞ TON: {price}‚ÇΩ")
                    self.last_ton_price = price
                else:
                    await utils.answer(message, self.strings("no_price_data"))
            else:
                await utils.answer(message, self.strings("button_not_found"))
                
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–¢–µ—Å—Ç–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è",
        en_doc="Test publication"
    )
    async def testbuttonpost(self, message):
        """–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç"""
        if not self.last_ton_price:
            await utils.answer(message, "‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ü–µ–Ω–µ")
            return
        
        post = self._format_post(self.last_ton_price)
        
        await self.client.send_message(
            self.target_channel,
            post,
            parse_mode='HTML'
        )
        
        await utils.answer(message, self.strings("test_sent"))
    
    @loader.command(
        ru_doc="–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç (–∫–Ω–æ–ø–∫–∞ + –ø–∞—Ä—Å–∏–Ω–≥ + –ø–æ—Å—Ç)",
        en_doc="Full test (button + parsing + post)"
    )
    async def fulltest(self, message):
        """–ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç"""
        await utils.answer(message, "üîÑ –ó–∞–ø—É—Å–∫–∞—é –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç...")
        
        try:
            # 1. –ò—â–µ–º –∏ –Ω–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É
            await utils.answer(message, self.strings("finding_button"))
            button_success = await self._find_and_click_wallet_button()
            
            if not button_success:
                await utils.answer(message, "‚ùå –ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                return
            
            await utils.answer(message, "‚úÖ –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞")
            
            # 2. –ñ–¥–µ–º –¥–∞–Ω–Ω—ã–µ
            await utils.answer(message, self.strings("waiting_data"))
            await asyncio.sleep(3)
            
            # 3. –ü–∞—Ä—Å–∏–º —Ü–µ–Ω—É
            await utils.answer(message, "üìä –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ...")
            price = await self._extract_price_from_messages()
            
            if not price:
                await utils.answer(message, "‚ùå –¶–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                return
            
            # 4. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å—Ç
            post = self._format_post(price)
            
            await self.client.send_message(
                self.target_channel,
                post,
                parse_mode='HTML'
            )
            
            # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            self.last_ton_price = price
            self.last_update = time.time()
            
            await utils.answer(message, f"‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!\nüíé –¶–µ–Ω–∞ TON: {price}‚ÇΩ")
            await message.respond(post, parse_mode='HTML')
            
        except Exception as e:
            await utils.answer(message, self.strings("error").format(str(e)))
    
    @loader.command(
        ru_doc="–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞",
        en_doc="Bot status"
    )
    async def buttonbotstatus(self, message):
        """–°—Ç–∞—Ç—É—Å"""
        status = "üü¢ –†–∞–±–æ—Ç–∞–µ—Ç" if self.is_running else "üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        
        last_time = "‚Äî"
        if self.last_update:
            last_time = self._get_msk_time_str(self.last_update)
        
        price_info = f"{self.last_ton_price}‚ÇΩ" if self.last_ton_price else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        button_state = "‚úÖ –ù–∞–π–¥–µ–Ω–∞" if self.button_found else "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞"
        
        info = f"{self.strings('status').format(status, last_time, price_info)}\n"
        info += f"üîò <b>–ö–Ω–æ–ø–∫–∞ '–ö–æ—à–µ–ª—ë–∫':</b> {button_state}"
        
        await utils.answer(message, info, parse_mode='HTML')
    
    async def _button_automation_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏"""
        logger.info("–¶–∏–∫–ª –∫–Ω–æ–ø–æ—á–Ω–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—É—â–µ–Ω")
        
        while self.is_running:
            try:
                # 1. –ò—â–µ–º –∏ –Ω–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É "–ö–æ—à–µ–ª—ë–∫"
                button_success = await self._find_and_click_wallet_button()
                
                if not button_success:
                    logger.warning("–ö–Ω–æ–ø–∫–∞ '–ö–æ—à–µ–ª—ë–∫' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                    await asyncio.sleep(60)  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
                    continue
                
                # 2. –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                await asyncio.sleep(3)
                
                # 3. –ü–∞—Ä—Å–∏–º —Ü–µ–Ω—É –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
                price = await self._extract_price_from_messages()
                
                if price:
                    # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—É
                    self.last_ton_price = price
                    self.last_update = time.time()
                    
                    # 5. –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å—Ç
                    post = self._format_post(price)
                    
                    await self.client.send_message(
                        self.target_channel,
                        post,
                        parse_mode='HTML'
                    )
                    
                    logger.info(f"–ü–æ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω | –¶–µ–Ω–∞ TON: {price}‚ÇΩ")
                
                # 6. –ñ–¥–µ–º 3 –º–∏–Ω—É—Ç—ã –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
                wait_time = 180  # 3 –º–∏–Ω—É—Ç—ã
                for i in range(wait_time):
                    if not self.is_running:
                        break
                    await asyncio.sleep(1)
                    
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏: {e}")
                await asyncio.sleep(30)
    
    async def _find_and_click_wallet_button(self):
        """–ü–æ–∏—Å–∫ –∏ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ '–ö–æ—à–µ–ª—ë–∫'"""
        try:
            # –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º /start –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
            await self.client.send_message(self.wallet_bot, "/start")
            await asyncio.sleep(2)
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
            messages = await self.client.get_messages(self.wallet_bot, limit=10)
            
            for msg in messages:
                # –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
                if hasattr(msg, 'reply_markup') and msg.reply_markup:
                    rows = msg.reply_markup.rows
                    
                    for row in rows:
                        for button in row.buttons:
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                            button_text = button.text.lower()
                            
                            # –ò—â–µ–º –∫–Ω–æ–ø–∫—É "–ö–æ—à–µ–ª—ë–∫" (—Å —É—á–µ—Ç–æ–º –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
                            if any(keyword in button_text for keyword in [
                                '–∫–æ—à–µ–ª–µ–∫', '–∫–æ—à–µ–ª—ë–∫', 'wallet', '–±–∞–ª–∞–Ω—Å', 'balance'
                            ]):
                                logger.info(f"–ù–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞: {button.text}")
                                
                                # –ù–∞–∂–∏–º–∞–µ–º –∫–Ω–æ–ø–∫—É
                                await msg.click(0, row.buttons.index(button))
                                self.button_found = True
                                
                                # –ñ–¥–µ–º –æ—Ç–≤–µ—Ç–∞
                                await asyncio.sleep(2)
                                return True
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –∫–Ω–æ–ø–∫–∞—Ö, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã
            logger.warning("–ö–Ω–æ–ø–∫–∞ '–ö–æ—à–µ–ª—ë–∫' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ reply_markup")
            
            # –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É
            await self.client.send_message(self.wallet_bot, "–∫–æ—à–µ–ª—ë–∫")
            await asyncio.sleep(2)
            
            await self.client.send_message(self.wallet_bot, "–±–∞–ª–∞–Ω—Å")
            await asyncio.sleep(2)
            
            # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –Ω–∞–π–¥–µ–Ω–Ω—É—é –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
            self.button_found = True
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏: {e}")
            self.button_found = False
            return False
    
    async def _extract_price_from_messages(self):
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ü–µ–Ω—ã TON –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
            messages = await self.client.get_messages(self.wallet_bot, limit=20)
            
            for msg in messages:
                if msg.text:
                    # –ò—â–µ–º —Ü–µ–Ω—É TON –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
                    price = self._parse_ton_price_from_text(msg.text)
                    if price:
                        logger.info(f"–¶–µ–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏: {price}")
                        return price
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
            await self.client.send_message(self.wallet_bot, "–∫—É—Ä—Å ton")
            await asyncio.sleep(2)
            
            messages = await self.client.get_messages(self.wallet_bot, limit=5)
            
            for msg in messages:
                if msg.text:
                    price = self._parse_ton_price_from_text(msg.text)
                    if price:
                        return price
            
            return None
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–µ–Ω—ã: {e}")
            return None
    
    def _parse_ton_price_from_text(self, text):
        """–ü–∞—Ä—Å–∏–Ω–≥ —Ü–µ–Ω—ã TON –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        try:
            # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ü–µ–Ω—ã TON
            patterns = [
                r'ton[:\s]*([\d\s]+[.,]\d+)\s*‚ÇΩ',
                r'–∫—É—Ä—Å.*ton[:\s]*([\d\s]+[.,]\d+)\s*‚ÇΩ',
                r'—Ü–µ–Ω–∞.*ton[:\s]*([\d\s]+[.,]\d+)\s*‚ÇΩ',
                r'([\d\s]+[.,]\d+)\s*‚ÇΩ.*ton',
                r'ton[:\s]*(\d+)\s*‚ÇΩ',  # –¶–µ–ª–æ–µ —á–∏—Å–ª–æ
                r'(\d+(?:[.,]\d+)?)\s*‚ÇΩ\s*–∑–∞\s*ton'
            ]
            
            for pattern in patterns:
                match = re.search(pattern, text, re.IGNORECASE)
                if match:
                    price_str = match.group(1).replace(' ', '').replace(',', '.')
                    return float(price_str)
            
            return None
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–∞: {e}")
            return None
    
    def _get_msk_time(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ –ú–°–ö"""
        utc_now = datetime.utcnow()
        msk_time = utc_now + timedelta(hours=3)
        return msk_time
    
    def _get_msk_time_str(self, timestamp=None):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ú–°–ö"""
        if timestamp:
            utc_time = datetime.utcfromtimestamp(timestamp)
            msk_time = utc_time + timedelta(hours=3)
        else:
            msk_time = self._get_msk_time()
        
        return msk_time.strftime("%H:%M –ú–°–ö")
    
    def _format_post(self, price):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞"""
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É
        if isinstance(price, (int, float)):
            if price.is_integer():
                price_str = f"{int(price):,}".replace(",", " ")
            else:
                price_str = f"{price:,.2f}".replace(",", " ").replace(".", ",")
        else:
            price_str = str(price)
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ú–°–ö
        msk_time = self._get_msk_time_str()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ—Å—Ç
        post = f"üíé TON: <b>{price_str}‚ÇΩ</b>\n\n"
        post += f"<i>üïê {msk_time} | @priceDollarTon</i>\n"
        post += f"<i>üè¶ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ @wallet</i>"
        
        return post
    
    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ"""
        self.is_running = False
        
        if self.task:
            self.task.cancel()
