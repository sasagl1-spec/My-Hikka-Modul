# -*- coding: utf-8 -*-
# –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≤ Telegram
# –¢–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö

from .. import loader, utils
import asyncio
import random
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

@loader.tds
class ContinuousPosterModule(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç—ã"""
    
    strings = {
        "name": "ContinuousPoster",
        "active": "‚ôæÔ∏è –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ü–∏–∫–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω",
        "inactive": "‚èπÔ∏è –¶–∏–∫–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω",
        "starting": "üöÄ –ó–∞–ø—É—Å–∫ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞...",
        "error": "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏"
    }

    def __init__(self):
        self.is_running = False
        self.task = None
        self.message_count = 0
        self.error_count = 0
        self.start_time = None
        
        # –¶–µ–ª–µ–≤—ã–µ —á–∞—Ç—ã –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.target_chats = [
            "https://t.me/piteraq",
            "https://t.me/vpiskavipspb",
            "https://t.me/VpISkA991", 
            "https://t.me/sextimeeeeeee",
            "https://t.me/vpiski_ekat",
            "https://t.me/tusovkimscspb",
            "https://t.me/vpiski_spb_piter_znakomstva",
            "https://t.me/vpiskimsksspb",
            "https://t.me/chat_berdjansk",
            "https://t.me/chatikiip",
            "https://t.me/vpisk_moskova",
            "https://t.me/moskva_vpiskip",
            "https://t.me/Moskvavispka",
            "https://t.me/vpiska_chelyaba001",
            "https://t.me/vpiskaa_spb",
            "https://t.me/vpiska_beseda"
        ]
        
        # –¢–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.message_text = "–≠—Å–∫–æ—Ä—Ç —É—Å–ª—É–≥–∏ —É –º–µ–Ω—è –≤ –ø—Ä–æ—Ñ–∏–ª–µü§§ \n–î–µ–≤—É—à–∫–∏ –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Åüíå"

    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("–ú–æ–¥—É–ª—å ContinuousPoster –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    async def cp_startcmd(self, message):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ü–∏–∫–ª: .cp_start"""
        if self.is_running:
            await utils.answer(message, "‚ÑπÔ∏è –¶–∏–∫–ª —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω")
            return
            
        self.is_running = True
        self.start_time = datetime.now()
        await utils.answer(message, self.strings["starting"])
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ
        self.task = asyncio.create_task(self.continuous_posting_loop())
        await utils.answer(message, self.strings["active"])
        
        logger.info(f"–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—É—â–µ–Ω –≤ {self.start_time}")

    async def cp_stopcmd(self, message):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–∏–∫–ª: .cp_stop"""
        if not self.is_running:
            await utils.answer(message, "‚ÑπÔ∏è –¶–∏–∫–ª –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω")
            return
            
        self.is_running = False
        if self.task:
            self.task.cancel()
            try:
                await self.task
            except asyncio.CancelledError:
                pass
                
        duration = datetime.now() - self.start_time if self.start_time else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        await utils.answer(message, f"{self.strings['inactive']}\n–†–∞–±–æ—Ç–∞–ª: {duration}")
        logger.info(f"–¶–∏–∫–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –†–∞–±–æ—Ç–∞–ª: {duration}")

    async def cp_statscmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: .cp_stats"""
        if self.start_time:
            duration = datetime.now() - self.start_time
            hours = duration.seconds // 3600
            minutes = (duration.seconds % 3600) // 60
            duration_str = f"{hours}—á {minutes}–º"
        else:
            duration_str = "–Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è"
            
        stats = f"""
üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ù–ï–ü–†–ï–†–´–í–ù–û–ì–û –¶–ò–ö–õ–ê:

‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {self.message_count}
‚Ä¢ –û—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏: {self.error_count}
‚Ä¢ –¶–µ–ª–µ–≤—ã—Ö —á–∞—Ç–æ–≤: {len(self.target_chats)}
‚Ä¢ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {duration_str}
‚Ä¢ –°—Ç–∞—Ç—É—Å: {'üü¢ –ê–ö–¢–ò–í–ï–ù' if self.is_running else 'üî¥ –û–°–¢–ê–ù–û–í–õ–ï–ù'}
‚Ä¢ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}

üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {self._calculate_efficiency()}%
        """
        await utils.answer(message, stats)

    async def cp_testcmd(self, message):
        """–ë—ã—Å—Ç—Ä–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞: .cp_test"""
        try:
            if not self.target_chats:
                await utils.answer(message, "‚ùå –ù–µ—Ç —Ü–µ–ª–µ–≤—ã—Ö —á–∞—Ç–æ–≤")
                return
                
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ 3 —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∞—Ç–∞ –±—ã—Å—Ç—Ä–æ
            selected_chats = random.sample(self.target_chats, min(3, len(self.target_chats)))
            
            for i, chat in enumerate(selected_chats):
                try:
                    await self.client.send_message(chat, self.message_text)
                    self.message_count += 1
                    await asyncio.sleep(0.5)  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                    
                except Exception as e:
                    self.error_count += 1
                    logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ç–µ—Å—Ç–µ {chat}: {e}")
            
            await utils.answer(message, f"‚úÖ –ë—ã—Å—Ç—Ä–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞\n–ß–∞—Ç–æ–≤: {len(selected_chats)}")
            
        except Exception as e:
            await utils.answer(message, f"{self.strings['error']}: {str(e)}")

    async def continuous_posting_loop(self):
        """–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 50-80 —Å–µ–∫—É–Ω–¥"""
        logger.info("–ó–∞–ø—É—â–µ–Ω –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏")
        
        cycle_number = 0
        
        while self.is_running:
            cycle_number += 1
            try:
                # –°–ª—É—á–∞–π–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª 50-80 —Å–µ–∫—É–Ω–¥
                delay = random.randint(50, 80)
                logger.info(f"–¶–∏–∫–ª #{cycle_number} - –û–∂–∏–¥–∞–Ω–∏–µ {delay} —Å–µ–∫—É–Ω–¥")
                
                await asyncio.sleep(delay)
                
                if not self.is_running:
                    break
                    
                # –í—ã–±–∏—Ä–∞–µ–º 3 —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∞—Ç–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ü–∏–∫–ª–∞
                if len(self.target_chats) >= 3:
                    selected_chats = random.sample(self.target_chats, 3)
                else:
                    selected_chats = self.target_chats
                
                # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞—Ç—ã
                successful_sends = 0
                
                for chat in selected_chats:
                    try:
                        await self.client.send_message(chat, self.message_text)
                        self.message_count += 1
                        successful_sends += 1
                        
                        # –ö–æ—Ä–æ—Ç–∫–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
                        await asyncio.sleep(random.uniform(0.3, 1.0))
                        
                    except Exception as e:
                        self.error_count += 1
                        logger.error(f"–¶–∏–∫–ª #{cycle_number}, –æ—à–∏–±–∫–∞ –≤ {chat}: {e}")
                        continue
                
                # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ü–∏–∫–ª–∞
                logger.info(
                    f"–¶–∏–∫–ª #{cycle_number} –∑–∞–≤–µ—Ä—à–µ–Ω:\n"
                    f"‚Ä¢ –£—Å–ø–µ—à–Ω–æ: {successful_sends}/{len(selected_chats)}\n"
                    f"‚Ä¢ –í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–æ–∫: {self.message_count}\n"
                    f"‚Ä¢ –û—à–∏–±–æ–∫: {self.error_count}\n"
                    f"‚Ä¢ –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}"
                )
                
                # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—à–∏–±–æ–∫
                if self.error_count > 20 and cycle_number % 10 == 0:
                    pause_time = random.randint(120, 300)
                    logger.warning(f"–ú–Ω–æ–≥–æ –æ—à–∏–±–æ–∫. –ü–∞—É–∑–∞ {pause_time} —Å–µ–∫—É–Ω–¥")
                    await asyncio.sleep(pause_time)
                    
            except asyncio.CancelledError:
                logger.info("–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–µ—Ä–≤–∞–Ω")
                break
                
            except Exception as e:
                logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í –¶–ò–ö–õ–ï #{cycle_number}: {e}")
                self.error_count += 1
                
                # –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
                if self.is_running:
                    recovery_delay = random.randint(30, 90)
                    logger.info(f"–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {recovery_delay} —Å–µ–∫—É–Ω–¥")
                    await asyncio.sleep(recovery_delay)

    def _calculate_efficiency(self):
        """–†–∞—Å—á–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏"""
        if self.message_count + self.error_count == 0:
            return 100
        efficiency = (self.message_count / (self.message_count + self.error_count)) * 100
        return round(efficiency, 1)

    async def cp_configcmd(self, message):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: .cp_config"""
        config_text = f"""
‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ú–û–î–£–õ–Ø:

‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏: 50-80 —Å–µ–∫—É–Ω–¥ (—Å–ª—É—á–∞–π–Ω—ã–π)
‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ü–∏–∫–ª: 3 —á–∞—Ç–∞
‚Ä¢ –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: ‚ôæÔ∏è –ë–ï–°–ö–û–ù–ï–ß–ù–´–ô –¶–ò–ö–õ
‚Ä¢ –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
‚Ä¢ –í—Å–µ–≥–æ —á–∞—Ç–æ–≤: {len(self.target_chats)}
‚Ä¢ –ê–≤—Ç–æ–ø–∞—É–∑–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö: –≤–∫–ª—é—á–µ–Ω–∞
‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: –≤–∫–ª—é—á–µ–Ω–æ
‚Ä¢ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {self.start_time.strftime('%Y-%m-%d %H:%M:%S') if self.start_time else '–Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è'}
        """
        await utils.answer(message, config_text)

    async def cp_pausecmd(self, message):
        """–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞: .cp_pause <—Å–µ–∫—É–Ω–¥—ã>"""
        args = utils.get_args_raw(message)
        
        if not args or not args.isdigit():
            await utils.answer(message, "‚ùå –£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –ø–∞—É–∑—ã –≤ —Å–µ–∫—É–Ω–¥–∞—Ö: .cp_pause 60")
            return
            
        pause_time = int(args)
        
        if pause_time > 3600:
            await utils.answer(message, "‚ö†Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞ - 3600 —Å–µ–∫—É–Ω–¥")
            return
            
        await utils.answer(message, f"‚è∏Ô∏è –ü–∞—É–∑–∞ –Ω–∞ {pause_time} —Å–µ–∫—É–Ω–¥...")
        await asyncio.sleep(pause_time)
        await utils.answer(message, f"‚ñ∂Ô∏è –ü–∞—É–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")

    async def on_unload(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è"""
        self.is_running = False
        if self.task:
            self.task.cancel()
        logger.info("–ú–æ–¥—É–ª—å ContinuousPoster –≤—ã–≥—Ä—É–∂–µ–Ω")

    async def cp_helpcmd(self, message):
        """–°–ø—Ä–∞–≤–∫–∞: .cp_help"""
        help_text = """
‚ôæÔ∏è –ú–û–î–£–õ–¨ –ù–ï–ü–†–ï–†–´–í–ù–û–ô –û–¢–ü–†–ê–í–ö–ò

–ö–û–ú–ê–ù–î–´:
‚Ä¢ .cp_start - –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
‚Ä¢ .cp_stop - –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–∏–∫–ª
‚Ä¢ .cp_stats - –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚Ä¢ .cp_test - –±—ã—Å—Ç—Ä–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
‚Ä¢ .cp_config - —Ç–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚Ä¢ .cp_pause <—Å–µ–∫> - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞—É–∑–∞
‚Ä¢ .cp_help - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

–û–°–û–ë–ï–ù–ù–û–°–¢–ò:
‚Ä¢ –ò–Ω—Ç–µ—Ä–≤–∞–ª: 50-80 —Å–µ–∫—É–Ω–¥ (—Å–ª—É—á–∞–π–Ω—ã–π)
‚Ä¢ –¶–∏–∫–ª: –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –¥–æ —Ä—É—á–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
‚Ä¢ –ó–∞ —Ü–∏–∫–ª: 3 —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∞—Ç–∞
‚Ä¢ –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

‚ö†Ô∏è –û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–´–ô –ú–û–î–£–õ–¨
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ
        """
        await utils.answer(message, help_text)
