# –ú–æ–¥—É–ª—å AutoMessage –¥–ª—è Hikka UserBot
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤—ã–±–æ—Ä–æ–º —à—Ä–∏—Ñ—Ç–∞ –∏ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
# –¢–û–õ–¨–ö–û –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π –≤ –≤–∞—à–∏—Ö —á–∞—Ç–∞—Ö
# @hikaribot

from .. import loader, utils
import asyncio
import random
import logging
from datetime import datetime

logger = logging.getLogger(__name__)

@loader.tds
class AutoMessageMod(loader.Module):
    """–ê–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è —Å —à—Ä–∏—Ñ—Ç–∞–º–∏ –∏ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    
    strings = {
        "name": "AutoMessage",
        "started": "‚úÖ <b>–ê–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–ø—É—â–µ–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ</b>\nüìù –¢–µ–∫—Å—Ç: <code>{text}</code>\nüïì –ó–∞–¥–µ—Ä–∂–∫–∞: {min}-{max} –º–∏–Ω\nüîÑ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {count}\nüé® –®—Ä–∏—Ñ—Ç: {font}\nüìå –¶–∏—Ç–∞—Ç–∞: {quote}",
        "stopped": "‚ùå <b>–ê–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</b>",
        "status": "üìä <b>–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–π:</b>\n{status}",
        "no_active": "‚ö†Ô∏è <b>–í —ç—Ç–æ–º —á–∞—Ç–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–π</b>",
        "stats": "üìà <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}\n–û—Å—Ç–∞–ª–æ—Å—å: {remaining}\n–°–ª–µ–¥—É—é—â–µ–µ —á–µ—Ä–µ–∑: ~{next_minutes} –º–∏–Ω",
        "list": "üìã <b>–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è:</b>\n{list}"
    }
    
    # –°–ª–æ–≤–∞—Ä—å —à—Ä–∏—Ñ—Ç–æ–≤ Telegram
    FONTS = {
        "–æ–±—ã—á–Ω—ã–π": "",  # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        "–∂–∏—Ä–Ω—ã–π": "**",  # **–∂–∏—Ä–Ω—ã–π**
        "–∫—É—Ä—Å–∏–≤": "__",  # __–∫—É—Ä—Å–∏–≤__
        "–º–æ–Ω–æ": "`",    # `–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π`
        "–∂–∏—Ä–Ω—ã–π+–∫—É—Ä—Å–∏–≤": "**__",  # **__–∂–∏—Ä–Ω—ã–π –∫—É—Ä—Å–∏–≤__**
        "–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π": "~~",  # ~~–∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π~~
        "—Å–ø–æ–π–ª–µ—Ä": "||",  # ||—Å–ø–æ–π–ª–µ—Ä||
        "—Å—Å—ã–ª–∫–∞": "[—Ç–µ–∫—Å—Ç](—Å—Å—ã–ª–∫–∞)",  # –®–∞–±–ª–æ–Ω –¥–ª—è —Å—Å—ã–ª–æ–∫
        "–∫–æ–¥": "```\n–∫–æ–¥\n```"  # –ë–ª–æ–∫ –∫–æ–¥–∞
    }
    
    def __init__(self):
        self.active_tasks = {}  # {chat_id: {task, text, min_delay, max_delay, count, font, quote}}
        self.stats = {}  # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —á–∞—Ç–∞–º
        self.message_counters = {}  # –°—á–µ—Ç—á–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    
    async def client_ready(self, client, db):
        self.client = client
        self.db = db
        logger.info("AutoMessage –∑–∞–≥—Ä—É–∂–µ–Ω")
    
    @loader.command(ru_doc="–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ")
    async def rasscmd(self, message):
        """[–º–∏–Ω_–∑–∞–¥–µ—Ä–∂–∫–∞] [–º–∞–∫—Å_–∑–∞–¥–µ—Ä–∂–∫–∞] [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ] [—à—Ä–∏—Ñ—Ç] [—Ü–∏—Ç–∞—Ç–∞?] <—Ç–µ–∫—Å—Ç> - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è"""
        
        # –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
        args = utils.get_args_raw(message)
        if not args:
            await utils.answer(message, self._get_help())
            return
        
        # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
        parts = args.split(" ", 4)
        
        if len(parts) < 4:
            await utils.answer(message, self._get_help())
            return
        
        try:
            min_delay = int(parts[0])  # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
            max_delay = int(parts[1])  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
            count = int(parts[2])      # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
            font_name = parts[3].lower()  # –ù–∞–∑–≤–∞–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞
            text = parts[4] if len(parts) > 4 else "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–µ—Ä–∂–∫–∏
            if min_delay < 1 or max_delay < min_delay:
                await utils.answer(message, "‚ö†Ô∏è <b>–ù–µ–≤–µ—Ä–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞</b>\n–ú–∏–Ω–∏–º—É–º: 1 –º–∏–Ω—É—Ç–∞\n–ú–∞–∫—Å–∏–º—É–º > –º–∏–Ω–∏–º—É–º–∞")
                return
            
            if count < 1:
                await utils.answer(message, "‚ö†Ô∏è <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0</b>")
                return
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —à—Ä–∏—Ñ—Ç
            if font_name not in self.FONTS:
                fonts_list = ", ".join(self.FONTS.keys())
                await utils.answer(message, f"‚ö†Ô∏è <b>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç</b>\n–î–æ—Å—Ç—É–ø–Ω—ã–µ: {fonts_list}")
                return
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            quote_mode = "—Ä–µ–ø–ª–∞–π" if message.is_reply else "–Ω–µ—Ç"
            
            # –ü–æ–ª—É—á–∞–µ–º chat_id
            chat_id = message.chat_id
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∑–∞–¥–∞—á—É –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
            await self._stop_in_chat(chat_id)
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
            task = asyncio.create_task(
                self._send_messages_loop(chat_id, text, min_delay, max_delay, count, font_name, quote_mode, message)
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É
            self.active_tasks[chat_id] = {
                "task": task,
                "text": text,
                "min_delay": min_delay,
                "max_delay": max_delay,
                "total_count": count,
                "font": font_name,
                "quote": quote_mode,
                "start_time": datetime.now()
            }
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            self.stats[chat_id] = {"sent": 0, "total": count}
            self.message_counters[chat_id] = 0
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–≥–ª–∞—Å–Ω–æ —à—Ä–∏—Ñ—Ç—É
            formatted_text = self._apply_font(text, font_name)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            response = self.strings("started").format(
                text=text[:50] + "..." if len(text) > 50 else text,
                min=min_delay,
                max=max_delay,
                count=count,
                font=font_name,
                quote=quote_mode
            )
            
            await utils.answer(message, response)
            logger.info(f"AutoMessage –∑–∞–ø—É—â–µ–Ω –≤ —á–∞—Ç–µ {chat_id}")
            
        except ValueError as e:
            await utils.answer(message, f"‚ö†Ô∏è <b>–û—à–∏–±–∫–∞ –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö:</b>\n{str(e)}")
        except Exception as e:
            await utils.answer(message, f"‚ùå <b>–û—à–∏–±–∫–∞:</b> {str(e)}")
            logger.error(f"–û—à–∏–±–∫–∞ –≤ rasscmd: {e}")
    
    @loader.command(ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ")
    async def rassstopcmd(self, message):
        """- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ"""
        chat_id = message.chat_id
        
        if chat_id in self.active_tasks:
            await self._stop_in_chat(chat_id)
            await utils.answer(message, self.strings("stopped"))
        else:
            await utils.answer(message, self.strings("no_active"))
    
    @loader.command(ru_doc="–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ")
    async def rassstatcmd(self, message):
        """- –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–π"""
        chat_id = message.chat_id
        
        if chat_id in self.active_tasks:
            task_info = self.active_tasks[chat_id]
            stats_info = self.stats.get(chat_id, {"sent": 0, "total": 0})
            
            status_text = (
                f"üìù <b>–¢–µ–∫—Å—Ç:</b> <code>{task_info['text'][:30]}...</code>\n"
                f"üïì <b>–ó–∞–¥–µ—Ä–∂–∫–∞:</b> {task_info['min_delay']}-{task_info['max_delay']} –º–∏–Ω\n"
                f"üî¢ <b>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</b> {stats_info['sent']}/{task_info['total_count']}\n"
                f"üé® <b>–®—Ä–∏—Ñ—Ç:</b> {task_info['font']}\n"
                f"üìå <b>–¶–∏—Ç–∞—Ç–∞:</b> {task_info['quote']}\n"
                f"‚è±Ô∏è <b>–ó–∞–ø—É—â–µ–Ω–æ:</b> {task_info['start_time'].strftime('%H:%M:%S')}"
            )
            
            await utils.answer(message, status_text)
        else:
            await utils.answer(message, self.strings("no_active"))
    
    @loader.command(ru_doc="–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–π")
    async def rasslistcmd(self, message):
        """- –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è"""
        if not self.active_tasks:
            await utils.answer(message, "üì≠ <b>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–π</b>")
            return
        
        list_text = ""
        for chat_id, task_info in self.active_tasks.items():
            try:
                chat = await self.client.get_entity(chat_id)
                chat_name = chat.title if hasattr(chat, 'title') else chat.first_name
                stats = self.stats.get(chat_id, {"sent": 0, "total": 0})
                
                list_text += (
                    f"\nüí¨ <b>{chat_name}</b>\n"
                    f"   üìù: {task_info['text'][:20]}...\n"
                    f"   üìä: {stats['sent']}/{task_info['total_count']}\n"
                    f"   üïì: {task_info['min_delay']}-{task_info['max_delay']} –º–∏–Ω\n"
                )
            except:
                list_text += f"\nüí¨ <b>–ß–∞—Ç {chat_id}</b> (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)\n"
        
        await utils.answer(message, self.strings("list").format(list=list_text))
    
    @loader.command(ru_doc="–î–æ—Å—Ç—É–ø–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã")
    async def rassfontscmd(self, message):
        """- –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã"""
        fonts_info = "üé® <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã:</b>\n\n"
        
        for font_name, font_code in self.FONTS.items():
            example = self._apply_font("–ø—Ä–∏–º–µ—Ä", font_name)
            fonts_info += f"‚Ä¢ <b>{font_name}</b>: <code>{example}</code>\n"
        
        fonts_info += "\n<i>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: .rass 10 20 5 –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</i>"
        await utils.answer(message, fonts_info)
    
    @loader.command(ru_doc="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è")
    async def rassstopallcmd(self, message):
        """- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è"""
        stopped_count = 0
        
        for chat_id in list(self.active_tasks.keys()):
            await self._stop_in_chat(chat_id)
            stopped_count += 1
        
        await utils.answer(message, f"üõë <b>–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {stopped_count} –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–π</b>")
    
    async def _send_messages_loop(self, chat_id, text, min_delay, max_delay, total_count, font_name, quote_mode, original_message):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        sent_count = 0
        
        while sent_count < total_count and chat_id in self.active_tasks:
            try:
                # –°–ª—É—á–∞–π–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
                delay_minutes = random.randint(min_delay, max_delay)
                delay_seconds = delay_minutes * 60
                
                # –ñ–¥–µ–º
                for _ in range(delay_seconds):
                    if chat_id not in self.active_tasks:
                        return
                    await asyncio.sleep(1)
                
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
                formatted_text = self._apply_font(text, font_name)
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                reply_to = None
                if quote_mode == "—Ä–µ–ø–ª–∞–π" and original_message.is_reply:
                    reply_to = original_message.reply_to_msg_id
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                await self.client.send_message(
                    entity=chat_id,
                    message=formatted_text,
                    reply_to=reply_to
                )
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                sent_count += 1
                self.message_counters[chat_id] = sent_count
                
                if chat_id in self.stats:
                    self.stats[chat_id]["sent"] = sent_count
                
                logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç {chat_id} ({sent_count}/{total_count})")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏ –ª–∏–º–∏—Ç–∞
                if sent_count >= total_count:
                    if chat_id in self.active_tasks:
                        del self.active_tasks[chat_id]
                    logger.info(f"–ê–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã –≤ —á–∞—Ç–µ {chat_id}")
                    break
                    
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç {chat_id}: {e}")
                # –ñ–¥–µ–º 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                await asyncio.sleep(30)
    
    async def _stop_in_chat(self, chat_id):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —á–∞—Ç–µ"""
        if chat_id in self.active_tasks:
            task_info = self.active_tasks[chat_id]
            task_info["task"].cancel()
            
            try:
                await task_info["task"]
            except asyncio.CancelledError:
                pass
            except Exception:
                pass
            
            del self.active_tasks[chat_id]
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –ë–î
            if chat_id in self.message_counters:
                await self.db.set(
                    __name__,
                    f"stats_{chat_id}",
                    {
                        "last_sent": self.message_counters[chat_id],
                        "total": task_info["total_count"],
                        "stopped_at": datetime.now().isoformat()
                    }
                )
                del self.message_counters[chat_id]
            
            logger.info(f"–ê–≤—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ —á–∞—Ç–µ {chat_id}")
    
    def _apply_font(self, text, font_name):
        """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç –∫ —Ç–µ–∫—Å—Ç—É"""
        font_code = self.FONTS.get(font_name, "")
        
        if not font_code:
            return text
        
        if font_name == "—Å—Å—ã–ª–∫–∞":
            # –î–ª—è —Å—Å—ã–ª–∫–∏ –Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: [—Ç–µ–∫—Å—Ç](URL)
            # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫—É, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
            if "http://" in text or "https://" in text:
                parts = text.split(" ", 1)
                if len(parts) == 2:
                    return f"[{parts[0]}]({parts[1]})"
                else:
                    return f"[—Å—Å—ã–ª–∫–∞]({text})"
            else:
                return text
        elif font_name == "–∫–æ–¥":
            return f"```\n{text}\n```"
        else:
            return f"{font_code}{text}{font_code[::-1] if len(font_code) > 1 else font_code}"
    
    def _get_help(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"""
        return (
            "üìñ <b>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã .rass:</b>\n\n"
            "<code>.rass [–º–∏–Ω] [–º–∞–∫—Å] [–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ] [—à—Ä–∏—Ñ—Ç] [—Ç–µ–∫—Å—Ç]</code>\n\n"
            "üìå <b>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:</b>\n"
            "‚Ä¢ <b>–º–∏–Ω</b> - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–º–∏–Ω—É—Ç—ã)\n"
            "‚Ä¢ <b>–º–∞–∫—Å</b> - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (–º–∏–Ω—É—Ç—ã)\n"
            "‚Ä¢ <b>–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</b> - —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å\n"
            "‚Ä¢ <b>—à—Ä–∏—Ñ—Ç</b> - —Å—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–∞\n"
            "‚Ä¢ <b>—Ç–µ–∫—Å—Ç</b> - —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏\n\n"
            "üé® <b>–®—Ä–∏—Ñ—Ç—ã:</b> –æ–±—ã—á–Ω—ã–π, –∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, –º–æ–Ω–æ, –∂–∏—Ä–Ω—ã–π+–∫—É—Ä—Å–∏–≤, –∑–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π, —Å–ø–æ–π–ª–µ—Ä, —Å—Å—ã–ª–∫–∞, –∫–æ–¥\n\n"
            "üí° <b>–î–ª—è —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</b> —Å–¥–µ–ª–∞–π—Ç–µ —Ä–µ–ø–ª–∞–π –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–º–∞–Ω–¥—ã\n\n"
            "üìå <b>–ü—Ä–∏–º–µ—Ä—ã:</b>\n"
            "<code>.rass 10 20 5 –∂–∏—Ä–Ω—ã–π –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!</code>\n"
            "<code>.rass 5 15 3 –º–æ–Ω–æ –ö–æ–¥: 12345</code>\n"
            "<code>.rass 30 60 10 –æ–±—ã—á–Ω—ã–π –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –≤—Å—Ç—Ä–µ—á–∞</code>"
        )
    
    async def on_unload(self):
        """–ü—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª—è –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏"""
        for chat_id in list(self.active_tasks.keys()):
            await self._stop_in_chat(chat_id)
        logger.info("AutoMessage –≤—ã–≥—Ä—É–∂–µ–Ω, –≤—Å–µ –∑–∞–¥–∞—á–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
